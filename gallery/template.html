<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FyLinx Gallery</title>

<style>
body{
  margin:0;
  font-family:system-ui, sans-serif;
  background:#111;
  color:#fff;
}

header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 16px;
}

header h1{
  font-size:14px;
  margin:0;
  letter-spacing:1px;
}

button{
  background:#fff;
  color:#000;
  border:0;
  padding:6px 14px;
  font-size:12px;
  cursor:pointer;
}

.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  grid-auto-rows:110px; /* default mobile */
  gap:8px;
  padding:8px;
}

@media(min-width:768px){ /* desktop */
  .gallery{
    grid-auto-rows:120px;
  }
}

.gallery img{
  width:100%;
  height:100%;
  object-fit:cover;
  cursor:pointer;
}

/* Landscape → lebar + lebih tinggi */
.gallery img.landscape{
  grid-column:span 2;   /* lebar 2 column */
  grid-row:span 2;      /* tinggi 2 row */
}

/* Portrait → tinggi 2 row */
.gallery img.portrait{
  grid-row:span 2;
}

footer{
  text-align:center;
  font-size:11px;
  padding:12px;
  opacity:.5;
}

/* Modal */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.9);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal img{
  max-width:95%;
  max-height:95%;
}
</style>
</head>

<body>

<header>
  <h1>FyLinx</h1>
  <button id="syncBtn">SYNC</button>
</header>

<div class="gallery" id="gallery"></div>

<footer>© FyLinx</footer>

<div class="modal" id="modal">
  <img id="modalImg">
</div>

<script>
const API_KEY   = "AIzaSyCyL4jxLN9w87WG20GqeEIAaUCupjKmn8U";
const FOLDER_ID = "1qEfxwXgPcvEPRlBKNNecsHaqFSRrAjTE";
const PAGE_SIZE = 100; // max per request

let nextPageToken = null;
const gallery = document.getElementById("gallery");
const modal = document.getElementById("modal");
const modalImg = document.getElementById("modalImg");
const syncBtn = document.getElementById("syncBtn");

let modalImageIds = [];
let currentIndex = 0;

// ------------------- Load ALL images at first -------------------
async function loadAllImages() {
  nextPageToken = null;
  gallery.innerHTML = "";
  modalImageIds = [];

  do {
    await loadImagesPage();
  } while (nextPageToken);
}

// ------------------- Fetch one page -------------------
async function loadImagesPage() {
  const query = encodeURIComponent(
    `'${FOLDER_ID}' in parents and mimeType contains 'image/'`
  );

  let url =
    `https://www.googleapis.com/drive/v3/files?` +
    `q=${query}` +
    `&orderBy=createdTime desc` +
    `&pageSize=${PAGE_SIZE}` +
    `&fields=nextPageToken,files(id,name)` +
    `&key=${API_KEY}`;

  if (nextPageToken) url += `&pageToken=${nextPageToken}`;

  const res = await fetch(url);
  const data = await res.json();

  nextPageToken = data.nextPageToken || null;

  data.files.forEach(file => addImage(file));
}

// ------------------- Add image to gallery -------------------
function addImage(file){
  // Skip if already exists
  if(document.querySelector(`#img-${file.id}`)) return;

  modalImageIds.unshift(file.id); // newest on top

  const img = document.createElement("img");
  img.id = `img-${file.id}`;
  img.src = `https://drive.google.com/thumbnail?id=${file.id}&sz=w500`; // fast thumbnail

  img.onload = ()=>{
    if(img.naturalWidth > img.naturalHeight){
      img.classList.add("landscape");
    } else {
      img.classList.add("portrait");
    }
  };

  img.onclick = ()=>openModal(file.id);
  gallery.prepend(img); // prepend new image on top
}

// ------------------- Modal popup -------------------
function openModal(fileId){
  currentIndex = modalImageIds.indexOf(fileId);
  modalImg.src = `https://lh3.googleusercontent.com/d/${fileId}`;
  modal.style.display = "flex";
}

// Close modal on click outside image
modal.onclick = (e)=>{
  if(e.target === modal) modal.style.display="none";
}

// ------------------- Modal left/right navigation -------------------
document.addEventListener("keydown", e=>{
  if(modal.style.display !== "flex") return;

  if(e.key === "ArrowRight"){ // next image
    currentIndex = (currentIndex + 1) % modalImageIds.length;
    modalImg.src = `https://lh3.googleusercontent.com/d/${modalImageIds[currentIndex]}`;
  }
  if(e.key === "ArrowLeft"){ // previous image
    currentIndex = (currentIndex - 1 + modalImageIds.length) % modalImageIds.length;
    modalImg.src = `https://lh3.googleusercontent.com/d/${modalImageIds[currentIndex]}`;
  }
  if(e.key === "Escape"){ // close modal
    modal.style.display = "none";
  }
});

// ------------------- SYNC button -------------------
// Append only new images on top
syncBtn.onclick = async ()=>{
  nextPageToken = null;
  await loadImagesPage(); // only prepend new images
};

// ------------------- Initial load -------------------
loadAllImages();
</script>

</body>
</html>
